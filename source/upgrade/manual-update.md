#Manual upgrade procudure from 2.4.4 SP2 to 3.0.0 with OpenDJ to OpenDJ.

This guide based on Ubuntu 14.04 host. For outher OS some system commands should be changed.

1. Install 2.4.4 SP2

2. Log into CE 2.4.4 SP2 and insall it

```
service gluu-server-2.4.4.2 start
service gluu-server-2.4.4.2 login
cd /install/community-edition-setup/
./setup.py
```

3. Exit and Stop 2.4.4 SP2
```
exit
service gluu-server-2.4.4.2 stop
```

4. Disable 2.4.4 SP2 service auto startup
```
/usr/sbin/update-rc.d -f gluu-server-2.4.4.2 disable
```

5. Instal 3.0.0

6. Backup OpenDJ, ox-ldap.properties, salt from 2.4.4 SP2 and copy it into 3.0.0
```
cd /opt/gluu-server-2.4.4.2/opt
tar -czf opendj.tar.gz opendj
cp opendj.tar.gz /opt/gluu-server-3.0.0/opt/

cp /opt/gluu-server-2.4.4.2/opt/apache-tomcat-7.0.65/conf/ox-ldap.properties /opt/gluu-server-3.0.0/tmp
cp /opt/gluu-server-2.4.4.2/opt/apache-tomcat-7.0.65/conf/salt /opt/gluu-server-3.0.0/tmp
```

7. Log into CE 3.0.0 and insall it
```
service gluu-server-3.0.0 start
service gluu-server-3.0.0 login
cd /install/community-edition-setup/
./setup.py
```

8. Verify if instaled services are up.

9. Stop OpenLDAP and all installed services
```
service oxauth stop
service identity stop
...
service solserver stop
```
10. Disable OpenLDAP.
```
/usr/sbin/update-rc.d -f solserver disable
```

11. Restore OpenDJ from 2.4.4 SP2
```
cd /opendj
rm -rf opendj
tar -xzf opendj.tar.gz
chown -R ldap:ldap opendj
```

12. Update OpenDJ java settings
```
/bin/su ldap -c "export OPENDJ_JAVA_HOME=/opt/jre; /opt/opendj/bin/dsjavaproperties"
```

13. Create OpenDJ init script
```
export OPENDJ_JAVA_HOME=/opt/jre; /opt/opendj/bin/create-rc-script --outputFile /etc/init.d/opendj --userName ldap
/usr/sbin/update-rc.d -f opendj enable
```

14. Update LDAP schema
```
cp -f /install/community-edition-setup/static/opendj/deprecated/101-ox.ldif /opt/opendj/config/schema/
```

15. In 3.0.0 user custom attributes objectClass is 'gluuCustomPerson'. It's defined in /opt/opendj/config/schema/77-customAttributes.ldif We need to add into it definition custom attributes from 2.4.4 SP2 /opt/opendj/config/schema/100-user.ldif Old custom attributes objectClass is based on orgInum. Example: ox-6657268F7461C8CE000150DA8011-oid

16. Fix OpenDJ autogenerated schema. We need to do 2 repalcement in /opt/opendj/config/schema/101-ox.ldif and /opt/opendj/config/schema/77-customAttributes.ldif.
 - `attributeTypes: ( oxAttribute:` to `attributeTypes: ( oxAttribute-`
 - `objectClasses: ( oxObjectClass:` to `objectClasses: ( oxObjectClass-`

16. Start OpenDJ
```
service opendj start
```

17. Verify startup messages in OpenDJ logs: /opt/opendj/logs/server.out and /opt/opendj/logs/errors

18. Restore ox-ldap.properties and salt from CE 2.4.4 SP2
```
cd /etc/gluu/conf
mv ox-ldap.properties ox-ldap.properties.3.0.0
mv salt salt.3.0.0
mv /tmp/ox-ldap.properties .
mv /tmp/salt .
chown -rR root:gluu /etc/gluu/conf
```
19. Start CE servces:
```
service oxauth start
service identity start
...
```

20. Verify if instaled services are up.
