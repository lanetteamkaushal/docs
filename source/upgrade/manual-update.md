#Manual upgrade procudure from 2.4.4 SP2 to 3.0.0 with OpenDJ to OpenDJ.

This guide is to upgrade Gluu Server 2.4.4.2 to 3.0.0 with existing OpenDJ. 

1\. Install 2.4.4 SP2

2\. Log into CE 2.4.4 SP2 and install it.

```
service gluu-server-2.4.4.2 start
service gluu-server-2.4.4.2 login
cd /install/community-edition-setup/
./setup.py
```

3\. Exit and Stop 2.4.4 SP2

```
exit
service gluu-server-2.4.4.2 stop
```

4\. Disable 2.4.4 SP2 service auto startup

ubuntu 14.04,16.04, Centos 6 and debian

```
/usr/sbin/update-rc.d -f gluu-server-2.4.4.2 disable
```

Centos7.2, RHEL

```
chkconfig gluu-server-2.4.4.2 off
checkconfig --list | grep gluu-server

```

5\. Install 3.0.0 rpm/deb, do not run setup script. 

6\. Backup OpenDJ, ox-ldap.properties, salt from 2.4.4 SP2 and copy it into 3.0.0

```
cd /opt/gluu-server-2.4.4.2/opt
tar -czf opendj.tar.gz opendj
cp opendj.tar.gz /opt/gluu-server-3.0.0/opt/

cp /opt/gluu-server-2.4.4.2/opt/apache-tomcat-7.0.65/conf/ox-ldap.properties /opt/gluu-server-3.0.0/tmp
cp /opt/gluu-server-2.4.4.2/opt/apache-tomcat-7.0.65/conf/salt /opt/gluu-server-3.0.0/tmp
```

7\. Log into CE 3.0.0 and run setup script

```
service gluu-server-3.0.0 start
service gluu-server-3.0.0 login
cd /install/community-edition-setup/
./setup.py
```

8\. Verify if installed services are up

9\. Stop OpenLDAP and all installed services

```
service oxauth stop
service identity stop
{all other services like passport, asimba..etc }

service solserver stop
```

10\. Disable OpenLDAP

```
/usr/sbin/update-rc.d -f solserver disable
```

11\. Restore OpenDJ from 2.4.4 SP2

```
cd /opendj
rm -rf opendj
tar -xzf opendj.tar.gz
chown -R ldap:ldap opendj
```

12\. Set JAVA HOME

```
/opt/opendj/config/java.properties set overwrite-env-java-home=true
/opt/opendj/config/java.properties set default.java-home=/opt/jre
```

13\. Update OpenDJ java settings

```
/bin/su ldap -c "export OPENDJ_JAVA_HOME=/opt/jre; /opt/opendj/bin/dsjavaproperties"
```

14\. Create OpenDJ init script

```
export OPENDJ_JAVA_HOME=/opt/jre; /opt/opendj/bin/create-rc-script --outputFile /etc/init.d/opendj --userName ldap
/usr/sbin/update-rc.d -f opendj enable
```

15\. Update LDAP schema

```
cp -f /install/community-edition-setup/static/opendj/deprecated/101-ox.ldif /opt/opendj/config/schema/
```

16\. In 3.0.0 user custom attributes objectClass is 'gluuCustomPerson'. 
It's defined in /opt/opendj/config/schema/77-customAttributes.ldif 
We need to add into it definition custom attributes from 2.4.4 SP2 
/opt/opendj/config/schema/100-user.ldif Old custom attributes objectClass is based on orgInum. 
Example: ox-6657268F7461C8CE000150DA8011-oid

Example:

```
objectClasses: ( ox-5F41B0A06B327FA600012E9F0380-oid NAME 'ox-5F41B0A06B327FA600012E9F0380'
  SUP top STRUCTURAL MUST
  objectClass MAY (mycustomAtrr1 $ mycustomAtrr2)
  X-ORIGIN 'gluu' )
```


17\. Fix OpenDJ autogenerated schema. We need to do 2 repalcement in /opt/opendj/config/schema/101-ox.ldif and /opt/opendj/config/schema/77-customAttributes.ldif.
 - "attributeTypes: ( oxAttribute:" to "attributeTypes: ( oxAttribute-"
 - "objectClasses: ( oxObjectClass:" to "objectClasses: ( oxObjectClass-"

This can be replaced by downloading the latest 101-ox.ldif

```
# wget https://raw.githubusercontent.com/GluuFederation/community-edition-setup/version_3.0.0/static/opendj/deprecated/101-ox.ldif
```

18\. Start OpenDJ


```
service opendj start
```

19\. Verify startup messages in OpenDJ logs: /opt/opendj/logs/server.out and /opt/opendj/logs/errors

20\. Restore ox-ldap.properties and salt from CE 2.4.4 SP2



```
cd /etc/gluu/conf
mv ox-ldap.properties ox-ldap.properties.3.0.0
mv salt salt.3.0.0
mv /tmp/ox-ldap.properties .
mv /tmp/salt .
chown -R root:gluu /etc/gluu/conf
```

21\. Start CE servces

```
service oxauth start
service identity start


```

22\. Verify if instaled services are up

23\. Update oxTrust JSON configuration
 - We need to update *personObjectClassTypes*, *personObjectClassDisplayNames* 
   and  *personCustomObjectClass*.


   In  3.0.0 these properties have next default values:
   ```
   personObjectClassTypes = gluuCustomPerson, gluuPerson, eduPerson
   personObjectClassDisplayNames = gluuCustomPerson, gluuPerson, eduPerson
   personCustomObjectClass = gluuCustomPerson
   ```
 - We need to update *ldifStore*, *velocityLog*.
   In  3.0.0 these properties have next default values:
   ldifStore = /var/ox/identity/removed*
   velocityLog = /opt/gluu/jetty/identity/logs/velocity.log

24\. Update oxTrust CacheRefesh snapshotFolder.
   New snapshotFolder = /var/ox/identity/cr-snapshots

##Notes:

1\. If in 2.4.4 SP2 environment SCIM was enabled we need to do:
 - Fill new properties: "scimUmaClientId", "scimUmaClientKeyId", "scimUmaResourceId", "scimUmaScope", "scimUmaClientKeyStoreFile", "scimUmaClientKeyStorePassword"
   These properties has same values as before. But in 3.0.0 we added prefix "scim" to all of them.
 - Copy /etc/certs/scim-rs.jks from 2.4.4 SP2 into 3.0.0